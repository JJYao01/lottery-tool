<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»£è³¼æ»¿é¡è´ˆ - å…¬å¹³æŠ½çç³»çµ±</title>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --bg-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            margin: 0;
            color: #333;
        }
        h1 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-align: center;
        }
        .container {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        /* è¼¸å…¥å€æ¨£å¼ */
        .input-section { display: block; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { font-weight: 600; display: block; margin-bottom: 8px; color: #444; font-size: 0.95rem;}
        textarea {
            width: 100%; height: 100px; padding: 12px;
            border: 2px solid #eee; border-radius: 12px;
            font-size: 14px; box-sizing: border-box; resize: vertical;
            font-family: inherit; transition: border-color 0.3s;
        }
        textarea:focus { border-color: var(--secondary-color); outline: none; }
        textarea.short-input { height: 60px; }
        .hint { font-size: 12px; color: #888; margin-top: 6px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        button {
            background: var(--secondary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(78, 205, 196, 0.2);
            flex: 1 1 auto; min-width: 120px;
        }
        button:active { transform: scale(0.98); }
        button.spin-btn {
            background: var(--primary-color); font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            display: none; width: 100%; max-width: 300px;
        }
        button.reset-btn { background: #95a5a6; display: none; box-shadow: none;}
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none;}

        /* æŠ½çé€²è¡Œå€ */
        .lottery-section { display: none; text-align: center; }
        
        /* æ™‚é–“æˆ³è¨˜èˆ‡ç‹€æ…‹ */
        .status-bar {
            background: #f8f9fa; padding: 10px; border-radius: 10px;
            margin-bottom: 15px; font-size: 0.9rem; color: #555;
            border-left: 4px solid var(--secondary-color);
            text-align: left;
        }
        .timestamp { font-weight: bold; color: var(--primary-color); }
        .current-prize { font-size: 1.2rem; font-weight: bold; color: #333; margin: 10px 0; min-height: 1.4em;}

        /* è½‰ç›¤å€åŸŸ */
        .wheel-wrapper {
            position: relative; width: 320px; height: 320px; margin: 20px auto;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }
        canvas { width: 100%; height: 100%; transform: rotate(-90deg); }
        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            z-index: 10; width: 40px; height: 50px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='%23333333' d='M384 192c0 87.4-117 243-168.3 307.2c-12.3 15.3-35.1 15.3-47.4 0C117 435 0 279.4 0 192C0 86 86 0 192 0s192 86 192 192z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center bottom; background-size: contain;
        }

        /* çµæœåˆ—è¡¨ */
        #result-list {
            margin-top: 25px; text-align: left; background: #fff;
            border-radius: 12px; padding: 15px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
            display: none;
        }
        #result-list h3 { margin: 0 0 10px 0; color: var(--primary-color); text-align: center;}
        .result-item {
            padding: 10px; border-bottom: 1px solid #eee;
            font-size: 1.1rem; display: flex; justify-content: space-between;
        }
        .result-item:last-child { border-bottom: none; }
        .winner-name { font-weight: bold; color: #333; }
        .prize-name { color: var(--secondary-color); font-weight: 600; }
        .winner-amount { font-size: 0.8em; color: #888; }

        @media (max-width: 400px) {
            .wheel-wrapper { width: 280px; height: 280px; }
        }
    </style>
</head>
<body>

<h1>ğŸ ä»£è³¼æ»¿é¡è´ˆæŠ½ç</h1>

<div class="container">
    
    <div class="input-section" id="inputSection">
        <div class="input-group">
            <label>ğŸ‘¥ æ­¥é©Ÿ 1: è¼¸å…¥åå–®èˆ‡é‡‘é¡ (ä¸€è¡Œä¸€ç­†)</label>
            <textarea id="dataInput" placeholder="å°æ˜ 1500&#10;å°è¯ 3000&#10;é˜¿ç¾ 500">å°æ˜ 1500
å°è¯ 3000
é˜¿ç¾ 500
å¤§å£¯ 4500
Kelly 2200</textarea>
            <div class="hint">æ ¼å¼ï¼šåå­— ç©ºæ ¼ é‡‘é¡</div>
        </div>

        <div class="input-group">
            <label>ğŸ† æ­¥é©Ÿ 2: è¼¸å…¥çé … (é¸å¡«ï¼Œä¸€è¡Œä¸€å€‹)</label>
            <textarea id="prizeInput" class="short-input" placeholder="ä¾‹å¦‚ï¼š&#10;Aè³ï¼šé«˜ç´šå¹é¢¨æ©Ÿ&#10;Bè³ï¼šä¿æº«æ¯çµ„"></textarea>
            <div class="hint">è‹¥ä¸è¼¸å…¥ï¼Œå°‡é è¨­æŠ½å‡ºä¸€ä½ã€Œå¹¸é‹å¾—ä¸»ã€ã€‚</div>
        </div>

        <div class="btn-group">
            <button onclick="prepareLottery()">ç¢ºèªè³‡æ–™ï¼Œæº–å‚™æŠ½ç</button>
        </div>
    </div>

    <div class="lottery-section" id="lotterySection">
        <div class="status-bar">
            <div>ğŸ•’ æ™‚é–“æˆ³è¨˜ï¼š<span id="timestamp" class="timestamp">ç­‰å¾…é–‹å§‹...</span></div>
            <div style="margin-top: 5px; font-size: 12px;">(æ­¤æ™‚é–“ç‚ºå³æ™‚ç¶²è·¯æ™‚é–“ï¼Œç¢ºä¿æŠ½çå…¬æ­£æ€§)</div>
        </div>
        
        <div id="currentStatusText" class="current-prize">æº–å‚™å°±ç·’ï¼</div>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="600" height="600"></canvas>
        </div>

        <div id="result-list">
            <h3>ğŸ‰ ä¸­çåå–® ğŸ‰</h3>
            <div id="resultItems"></div>
        </div>

        <div class="btn-group">
            <button class="spin-btn" id="spinBtn" onclick="startAutoDraw()">â–¶ é–‹å§‹é€£çºŒæŠ½ç (å…¨ç¨‹éŒ„å½±ä¸­)</button>
            <button class="reset-btn" id="resetBtn" onclick="reset()">ä¿®æ”¹è³‡æ–™ / é‡ç½®</button>
        </div>
    </div>

</div>

<script>
    let participants = []; // ç•¶å‰åƒèˆ‡è€… (æœƒéš¨æŠ½çæ¸›å°‘)
    let allParticipantsForView = []; // åƒ…ä¾›é¡¯ç¤ºç¸½é‡‘é¡ç”¨
    let prizes = []; // çå“åˆ—è¡¨
    let currentPrizeIndex = 0; // ç›®å‰æŠ½åˆ°ç¬¬å¹¾å€‹ç
    let isDrawing = false;
    let timeInterval;
    
    // è½‰ç›¤é…è‰² (æ›´æŸ”å’Œå°ˆæ¥­)
    let colors = ['#FF8A80', '#82B1FF', '#B39DDB', '#80CBC4', '#F48FB1', '#FFCC80', '#90CAF9', '#A5D6A7', '#E6EE9C'];

    let canvas = document.getElementById('wheelCanvas');
    let ctx = canvas.getContext('2d');
    // å¢åŠ è§£æåº¦ä»¥é˜²æ¨¡ç³Š
    canvas.width = 600; canvas.height = 600;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const outsideRadius = canvas.width * 0.42;
    const textRadius = canvas.width * 0.32;

    let currentRotation = 0;
    let spinTimeout = null;
    let spinAngleStart = 0;
    let spinTime = 0;
    let spinTimeTotal = 0;

    // --- æ ¸å¿ƒåŠŸèƒ½ ---

    // 1. æº–å‚™æŠ½çè³‡æ–™
    function prepareLottery() {
        const dataInput = document.getElementById('dataInput').value.trim();
        const prizeInput = document.getElementById('prizeInput').value.trim();

        if (!dataInput) return alert("è«‹è¼¸å…¥åƒèˆ‡è€…åå–®èˆ‡é‡‘é¡");

        // è§£æåå–®
        participants = [];
        let totalAmount = 0;
        dataInput.split('\n').forEach(line => {
            let parts = line.trim().split(/\s+/);
            if (parts.length >= 2) {
                let name = parts.slice(0, parts.length - 1).join(" "); // è™•ç†åå­—ä¸­æœ‰ç©ºæ ¼çš„æƒ…æ³
                let amount = parseFloat(parts[parts.length - 1]);
                if (!isNaN(amount) && amount > 0) {
                    participants.push({ name, amount, originalIndex: participants.length });
                    totalAmount += amount;
                }
            }
        });

        if (participants.length < 2) return alert("è‡³å°‘éœ€è¦å…©å€‹äººæ‰èƒ½æŠ½ç");
        allParticipantsForView = [...participants]; // å‚™ä»½ä¸€ä»½

        // è§£æçå“
        prizes = prizeInput ? prizeInput.split('\n').filter(p => p.trim() !== '') : ["å¹¸é‹å¾—ä¸»"];
        
        if (prizes.length > participants.length) {
             return alert(`éŒ¯èª¤ï¼šçå“æ•¸é‡ (${prizes.length}) å¤šæ–¼åƒèˆ‡äººæ•¸ (${participants.length})`);
        }

        currentPrizeIndex = 0;
        calculateWeights();
        drawWheel();
        
        // åˆ‡æ›ä»‹é¢
        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('lotterySection').style.display = 'block';
        document.getElementById('spinBtn').style.display = 'inline-block';
        document.getElementById('resetBtn').style.display = 'inline-block';
        document.getElementById('result-list').style.display = 'none';
        document.getElementById('resultItems').innerHTML = '';
        document.getElementById('currentStatusText').innerText = `ç¸½é‡‘é¡: $${totalAmount}ï¼Œå…± ${prizes.length} å€‹çé …ã€‚æº–å‚™é–‹å§‹ï¼`;

        // é–‹å§‹æ›´æ–°æ™‚é–“
        updateTimestamp();
        timeInterval = setInterval(updateTimestamp, 1000);
    }

    // è¨ˆç®—æ¬Šé‡ (æ¯æ¬¡æœ‰äººä¸­çå¾Œéƒ½è¦é‡æ–°è¨ˆç®—)
    function calculateWeights() {
        let currentTotal = participants.reduce((sum, p) => sum + p.amount, 0);
        participants.forEach(p => {
            p.angle = (p.amount / currentTotal) * (Math.PI * 2);
        });
    }

    // ç¹ªè£½è½‰ç›¤
    function drawWheel() {
        let currentAngle = currentRotation;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç¹ªè£½å¤–æ¡†è£é£¾
        ctx.beginPath();
        ctx.arc(centerX, centerY, outsideRadius + 10, 0, Math.PI * 2);
        ctx.fillStyle = "#fff";
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = "#eee";
        ctx.stroke();

        participants.forEach((p, i) => {
            // æ‰‡å½¢
            ctx.fillStyle = colors[p.originalIndex % colors.length];
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, outsideRadius, currentAngle, currentAngle + p.angle);
            ctx.lineTo(centerX, centerY);
            ctx.fill();
            // æ‰‡å½¢é‚Šç·š
            ctx.lineWidth = 2;
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.stroke();

            // æ–‡å­—
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(currentAngle + p.angle / 2 + Math.PI / 2);
            ctx.translate(0, -textRadius);
            
            ctx.fillStyle = "#444"; // æ–‡å­—é¡è‰²æ”¹æ·±è‰²æ›´å®¹æ˜“é–±è®€
            ctx.font = 'bold 28px sans-serif';
            ctx.textAlign = "center";
            ctx.fillText(p.name, 0, 0);
            ctx.font = '18px sans-serif';
            ctx.fillStyle = "#666";
            ctx.fillText(`$${p.amount}`, 0, 26);
            ctx.restore();
            
            currentAngle += p.angle;
        });
    }

    // --- æŠ½çæµç¨‹æ§åˆ¶ ---

    // é–‹å§‹è‡ªå‹•é€£çºŒæŠ½ç
    function startAutoDraw() {
        if (isDrawing) return;
        isDrawing = true;
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('resetBtn').disabled = true;
        document.getElementById('result-list').style.display = 'block';
        drawNextPrize();
    }

    // æŠ½ä¸‹ä¸€å€‹çå“
    function drawNextPrize() {
        if (currentPrizeIndex >= prizes.length || participants.length === 0) {
            // å…¨éƒ¨æŠ½å®Œ
            finishDraw();
            return;
        }

        let prizeName = prizes[currentPrizeIndex];
        document.getElementById('currentStatusText').innerHTML = `ğŸ”¥ æ­£åœ¨æŠ½å‡ºï¼š<span style="color:var(--primary-color);font-size:1.4em;">[ ${prizeName} ]</span>`;
        
        // é–‹å§‹æ—‹è½‰å‹•ç•«
        spin();
    }

    // åŸ·è¡Œæ—‹è½‰ (å–®æ¬¡)
    function spin() {
        // éš¨æ©Ÿåƒæ•¸ç¢ºä¿æ¯æ¬¡è½‰å‹•ä¸åŒ
        spinAngleStart = Math.random() * 10 + 25; // åˆå§‹é€Ÿåº¦
        spinTime = 0;
        spinTimeTotal = Math.random() * 2000 + 4000; // è½‰å‹•æ™‚é–“ 4~6ç§’
        rotateWheel();
    }

    function rotateWheel() {
        spinTime += 30;
        if (spinTime >= spinTimeTotal) {
            stopRotateWheel();
            return;
        }
        // ç·©å‹•æ•ˆæœ (Ease Out Cubic)
        let t = spinTime;
        let b = spinAngleStart;
        let c = -spinAngleStart;
        let d = spinTimeTotal;
        let currentSpeed = c * ((t = t / d - 1) * t * t + 1) + b;

        currentRotation += (currentSpeed * Math.PI / 180);
        drawWheel();
        spinTimeout = setTimeout(rotateWheel, 30);
    }

    // åœæ­¢æ—‹è½‰ä¸¦åˆ¤å®šçµæœ
    function stopRotateWheel() {
        clearTimeout(spinTimeout);
        
        // è¨ˆç®—ä¸­çè€…
        const degrees = currentRotation * 180 / Math.PI + 90;
        let normalizedRotation = currentRotation % (Math.PI * 2);
        let pointerAngle = (Math.PI * 1.5 - normalizedRotation);
        while(pointerAngle < 0) pointerAngle += Math.PI * 2;
        while(pointerAngle > Math.PI * 2) pointerAngle -= Math.PI * 2;

        let winner = null;
        let angleSoFar = 0;
        for(let p of participants) {
            if (pointerAngle >= angleSoFar && pointerAngle < angleSoFar + p.angle) {
                winner = p;
                break;
            }
            angleSoFar += p.angle;
        }

        if(winner) {
            let prizeName = prizes[currentPrizeIndex];
            document.getElementById('currentStatusText').innerHTML = `ğŸ‰ æ­å–œ <span style="color:var(--primary-color);">${winner.name}</span> ç²å¾— [ ${prizeName} ]ï¼`;
            
            // æ·»åŠ åˆ°çµæœåˆ—è¡¨
            addResultToList(prizeName, winner);

            // ç§»é™¤ä¸­çè€…
            participants = participants.filter(p => p !== winner);

            // æº–å‚™ä¸‹ä¸€æ¬¡æŠ½ç
            currentPrizeIndex++;
            
            // åœé “ 3 ç§’è®“å¤§å®¶çœ‹æ¸…æ¥šçµæœï¼Œå†é€²è¡Œä¸‹ä¸€è¼ª
            setTimeout(() => {
                if (currentPrizeIndex < prizes.length && participants.length > 0) {
                    calculateWeights(); // é‡æ–°è¨ˆç®—æ¬Šé‡
                    drawWheel(); // é‡ç¹ªè½‰ç›¤
                    setTimeout(drawNextPrize, 1000); // å†ç­‰ä¸€ç§’å¾Œé–‹å§‹è½‰
                } else {
                    finishDraw();
                }
            }, 3000);
        }
    }

    // æŠ½çå…¨éƒ¨çµæŸ
    function finishDraw() {
        isDrawing = false;
        document.getElementById('currentStatusText').innerText = "ğŸŠ æŠ½çæ´»å‹•åœ“æ»¿çµæŸï¼æ„Ÿè¬å¤§å®¶åƒèˆ‡ ğŸŠ";
        document.getElementById('spinBtn').style.display = 'none'; // éš±è—é–‹å§‹æŒ‰éˆ•
        document.getElementById('resetBtn').disabled = false;
        clearInterval(timeInterval);
    }

    // è¼”åŠ©åŠŸèƒ½ï¼šæ–°å¢çµæœåˆ°åˆ—è¡¨
    function addResultToList(prize, winner) {
        const resultDiv = document.getElementById('resultItems');
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
            <div><span class="prize-name">${prize}</span></div>
            <div style="text-align:right;">
                <span class="winner-name">${winner.name}</span><br>
                <span class="winner-amount">(å‡ºè³‡ $${winner.amount})</span>
            </div>
        `;
        resultDiv.prepend(item); // æ–°çš„çµæœåœ¨æœ€ä¸Šé¢
    }

    // è¼”åŠ©åŠŸèƒ½ï¼šæ›´æ–°æ™‚é–“æˆ³è¨˜
    function updateTimestamp() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
        const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
        document.getElementById('timestamp').innerText = `${dateStr} ${timeStr}`;
    }

    // é‡ç½®
    function reset() {
        if (isDrawing) return;
        clearInterval(timeInterval);
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('lotterySection').style.display = 'none';
        document.getElementById('spinBtn').disabled = false;
        document.getElementById('resetBtn').disabled = false;
        currentRotation = 0;
    }
</script>

</body>
</html>
