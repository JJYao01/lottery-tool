<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»£è³¼æ»¿é¡è´ˆ - å…¬å¹³æŠ½çç³»çµ±</title>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --bg-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --card-bg: rgba(255, 255, 255, 0.98);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            margin: 0;
            color: #333;
        }
        h1 {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-align: center;
        }
        .container {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
        }
        
        /* è¼¸å…¥å€æ¨£å¼ */
        .input-section { display: block; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { font-weight: 600; display: block; margin-bottom: 8px; color: #444; }
        textarea {
            width: 100%; height: 100px; padding: 12px;
            border: 2px solid #eee; border-radius: 12px;
            font-size: 14px; box-sizing: border-box; resize: vertical;
        }
        textarea:focus { border-color: var(--secondary-color); outline: none; }
        .short-input { height: 60px; }
        .hint { font-size: 12px; color: #888; margin-top: 6px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        button {
            background: var(--secondary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(78, 205, 196, 0.2);
            flex: 1 1 auto; min-width: 120px;
        }
        button:active { transform: scale(0.98); }
        button.spin-btn {
            background: var(--primary-color); font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            display: none; width: 100%; max-width: 300px;
        }
        button.reset-btn { background: #95a5a6; display: none; box-shadow: none;}
        button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7;}

        /* æŠ½çé€²è¡Œå€ */
        .lottery-section { display: none; text-align: center; }
        
        .status-bar {
            background: #f8f9fa; padding: 10px; border-radius: 10px;
            margin-bottom: 15px; font-size: 0.9rem; color: #555;
            border-left: 4px solid var(--secondary-color);
            text-align: left;
        }
        .timestamp { font-weight: bold; color: var(--primary-color); }
        .current-prize { font-size: 1.2rem; font-weight: bold; color: #333; margin: 10px 0; min-height: 1.4em;}

        /* è½‰ç›¤å€åŸŸ */
        .wheel-wrapper {
            position: relative; width: 320px; height: 320px; margin: 20px auto;
        }
        canvas { width: 100%; height: 100%; } /* ç§»é™¤ CSS æ—‹è½‰ï¼Œæ”¹ç”¨ç¨‹å¼æ§åˆ¶ */
        
        /* æŒ‡é‡ï¼šå›ºå®šåœ¨æ­£ä¸Šæ–¹ */
        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            z-index: 10; width: 40px; height: 50px;
            /* ä½¿ç”¨ SVG ç¹ªè£½ä¸€å€‹æ˜é¡¯çš„å€’ä¸‰è§’å½¢ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 512'%3E%3Cpath fill='%23333' d='M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center bottom; background-size: contain;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* çµæœåˆ—è¡¨ */
        #result-list {
            margin-top: 25px; text-align: left; background: #fff;
            border-radius: 12px; padding: 15px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
            display: none;
        }
        .result-item {
            padding: 10px; border-bottom: 1px solid #eee;
            font-size: 1.1rem; display: flex; justify-content: space-between;
        }
        .winner-name { font-weight: bold; color: #333; }
        .prize-name { color: var(--secondary-color); font-weight: 600; }
    </style>
</head>
<body>

<h1>ğŸ ä»£è³¼æ»¿é¡è´ˆæŠ½ç (ä¿®æ­£ç‰ˆ)</h1>

<div class="container">
    
    <div class="input-section" id="inputSection">
        <div class="input-group">
            <label>ğŸ‘¥ æ­¥é©Ÿ 1: è¼¸å…¥åå–®èˆ‡é‡‘é¡</label>
            <textarea id="dataInput" placeholder="å°æ˜ 1500&#10;å°è¯ 3000&#10;é˜¿ç¾ 500">å°æ˜ 1500
å°è¯ 3000
é˜¿ç¾ 500
å¤§å£¯ 4500
Kelly 2200</textarea>
        </div>

        <div class="input-group">
            <label>ğŸ† æ­¥é©Ÿ 2: è¼¸å…¥çé …</label>
            <textarea id="prizeInput" class="short-input" placeholder="Aè³ï¼šé«˜ç´šå¹é¢¨æ©Ÿ&#10;Bè³ï¼šä¿æº«æ¯çµ„"></textarea>
        </div>

        <div class="btn-group">
            <button onclick="prepareLottery()">ç¢ºèªè³‡æ–™ï¼Œæº–å‚™æŠ½ç</button>
        </div>
    </div>

    <div class="lottery-section" id="lotterySection">
        <div class="status-bar">
            <div>ğŸ•’ æ™‚é–“ï¼š<span id="timestamp" class="timestamp">--:--:--</span></div>
        </div>
        
        <div id="currentStatusText" class="current-prize">æº–å‚™å°±ç·’</div>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="600" height="600"></canvas>
        </div>

        <div id="result-list">
            <h3 style="margin:0 0 10px 0; text-align:center; color:#FF6B6B;">ğŸ‰ ä¸­çåå–®</h3>
            <div id="resultItems"></div>
        </div>

        <div class="btn-group">
            <button class="spin-btn" id="spinBtn" onclick="startAutoDraw()">â–¶ é–‹å§‹æŠ½ç (éŒ„å½±ä¸­)</button>
            <button class="reset-btn" id="resetBtn" onclick="reset()">é‡ç½® / ä¿®æ”¹</button>
        </div>
    </div>

</div>

<script>
    let participants = [];
    let prizes = [];
    let currentPrizeIndex = 0;
    let isDrawing = false;
    let timeInterval;
    
    // è½‰ç›¤é¡è‰²
    let colors = ['#FF8A80', '#82B1FF', '#B39DDB', '#80CBC4', '#F48FB1', '#FFCC80', '#90CAF9', '#A5D6A7', '#E6EE9C'];

    let canvas = document.getElementById('wheelCanvas');
    let ctx = canvas.getContext('2d');
    canvas.width = 600; canvas.height = 600;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const outsideRadius = canvas.width * 0.42;
    const textRadius = canvas.width * 0.32;

    let currentRotation = 0; // ç´¯ç©æ—‹è½‰è§’åº¦ (å¼§åº¦)
    let spinTimeout = null;
    let spinAngleStart = 0;
    let spinTime = 0;
    let spinTimeTotal = 0;

    // --- æ ¸å¿ƒé‚è¼¯ ---

    function prepareLottery() {
        const dataInput = document.getElementById('dataInput').value.trim();
        const prizeInput = document.getElementById('prizeInput').value.trim();
        if (!dataInput) return alert("è«‹è¼¸å…¥åå–®");

        participants = [];
        let totalAmount = 0;
        dataInput.split('\n').forEach(line => {
            let parts = line.trim().split(/\s+/);
            if (parts.length >= 2) {
                let name = parts.slice(0, parts.length - 1).join(" ");
                let amount = parseFloat(parts[parts.length - 1]);
                if (!isNaN(amount) && amount > 0) {
                    participants.push({ name, amount, originalIndex: participants.length });
                    totalAmount += amount;
                }
            }
        });

        if (participants.length < 2) return alert("è‡³å°‘éœ€è¦å…©äºº");

        prizes = prizeInput ? prizeInput.split('\n').filter(p => p.trim() !== '') : ["å¹¸é‹å¾—ä¸»"];
        if (prizes.length > participants.length) return alert("çå“æ•¸é‡ä¸èƒ½å¤šæ–¼äººæ•¸");

        currentPrizeIndex = 0;
        calculateWeights(); // è¨ˆç®—è§’åº¦
        drawWheel(); // ç¹ªè£½åˆå§‹ç‹€æ…‹
        
        // åˆ‡æ›ç•«é¢
        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('lotterySection').style.display = 'block';
        document.getElementById('spinBtn').style.display = 'inline-block';
        document.getElementById('resetBtn').style.display = 'inline-block';
        document.getElementById('result-list').style.display = 'none';
        document.getElementById('resultItems').innerHTML = '';
        document.getElementById('currentStatusText').innerText = `ç¸½é‡‘é¡: $${totalAmount}ï¼Œå…± ${prizes.length} å€‹çé …`;

        updateTimestamp();
        if(timeInterval) clearInterval(timeInterval);
        timeInterval = setInterval(updateTimestamp, 1000);
    }

    function calculateWeights() {
        let currentTotal = participants.reduce((sum, p) => sum + p.amount, 0);
        let startAngle = 0;
        participants.forEach(p => {
            p.angle = (p.amount / currentTotal) * (Math.PI * 2);
            p.startAngle = startAngle;
            p.endAngle = startAngle + p.angle;
            startAngle += p.angle;
        });
    }

    function drawWheel() {
        // åœ¨ Canvas ç¹ªåœ–æ™‚ï¼Œæˆ‘å€‘è¦åŠ ä¸Š currentRotation
        // ç‚ºäº†è®“æŒ‡é‡æŒ‡åœ¨æ­£ä¸Šæ–¹ (270åº¦ / 1.5 PI)ï¼Œæˆ‘å€‘éœ€è¦åšä¸€äº›æ—‹è½‰è™•ç†
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç•«å¤–æ¡†
        ctx.beginPath();
        ctx.arc(centerX, centerY, outsideRadius + 10, 0, Math.PI * 2);
        ctx.fillStyle = "#fff";
        ctx.fill();
        ctx.stroke();

        ctx.save();
        // å°‡ç•«å¸ƒä¸­å¿ƒç§»åˆ°ä¸­é–“
        ctx.translate(centerX, centerY);
        // æ—‹è½‰ç•«å¸ƒ (é€™æ˜¯é—œéµï¼šè½‰ç›¤åœ¨è½‰)
        ctx.rotate(currentRotation);

        participants.forEach((p) => {
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, outsideRadius, p.startAngle, p.endAngle);
            ctx.lineTo(0, 0);
            ctx.fillStyle = colors[p.originalIndex % colors.length];
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();

            // æ–‡å­—
            ctx.save();
            let textAngle = p.startAngle + p.angle / 2;
            ctx.rotate(textAngle);
            ctx.translate(textRadius, 0);
            // æ–‡å­—ä¸éœ€è¦å†è½‰ 90 åº¦ï¼Œå› ç‚ºç¾åœ¨ 0 åº¦å°±æ˜¯å‘å³
            // ä½†ç‚ºäº†é–±è®€æ–¹ä¾¿ï¼Œæˆ‘å€‘é€šå¸¸å¸Œæœ›æ–‡å­—æœå‘åœ“å¿ƒæˆ–èƒŒå‘åœ“å¿ƒ
            // é€™è£¡è¨­å®šæ–‡å­—æ°´å¹³
            
            ctx.fillStyle = "#333";
            ctx.font = 'bold 26px Arial';
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(p.name, 0, 0);
            ctx.font = '16px Arial';
            ctx.fillText(`$${p.amount}`, 0, 24);
            ctx.restore();
        });

        ctx.restore();
    }

    // --- æŠ½çé‚è¼¯ ---

    function startAutoDraw() {
        if (isDrawing) return;
        isDrawing = true;
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('resetBtn').disabled = true;
        document.getElementById('result-list').style.display = 'block';
        drawNextPrize();
    }

    function drawNextPrize() {
        if (currentPrizeIndex >= prizes.length || participants.length === 0) {
            finishDraw();
            return;
        }
        let prizeName = prizes[currentPrizeIndex];
        document.getElementById('currentStatusText').innerHTML = `ğŸ”¥ æ­£åœ¨æŠ½å‡ºï¼š<span style="color:#FF6B6B;font-size:1.3em;">[ ${prizeName} ]</span>`;
        spin();
    }

    function spin() {
        spinAngleStart = Math.random() * 10 + 20; 
        spinTime = 0;
        spinTimeTotal = Math.random() * 2000 + 4000;
        rotateWheel();
    }

    function rotateWheel() {
        spinTime += 30;
        if (spinTime >= spinTimeTotal) {
            stopRotateWheel();
            return;
        }
        let t = spinTime;
        let b = spinAngleStart;
        let c = -spinAngleStart;
        let d = spinTimeTotal;
        let currentSpeed = c * ((t = t / d - 1) * t * t + 1) + b; // Ease out

        currentRotation += (currentSpeed * Math.PI / 180);
        drawWheel();
        spinTimeout = setTimeout(rotateWheel, 30);
    }

    function stopRotateWheel() {
        clearTimeout(spinTimeout);

        // æ•¸å­¸é©—è­‰æ ¸å¿ƒï¼š
        // 1. æŒ‡é‡ä½ç½®å›ºå®šåœ¨æ­£ä¸Šæ–¹ (Canvas çš„ 270åº¦, æˆ– 1.5 * PI)
        // 2. è½‰ç›¤è½‰äº† currentRotation
        // 3. æˆ‘å€‘è¦æ‰¾å‡ºï¼šå“ªä¸€å€‹æ‰‡å½¢çš„å€åŸŸï¼Œåœ¨æ—‹è½‰å¾Œï¼Œè¦†è“‹äº† 270åº¦ï¼Ÿ

        // å°‡ currentRotation æ­£è¦åŒ–åˆ° 0 ~ 2PI
        let actualRotation = currentRotation % (Math.PI * 2);
        
        // è¨ˆç®—ã€ŒæŒ‡é‡ç›¸å°æ–¼è½‰ç›¤ 0 é»çš„è§’åº¦ã€
        // æƒ³åƒè½‰ç›¤æ²’å‹•ï¼Œæ˜¯æŒ‡é‡å¾€åæ–¹å‘è½‰äº† actualRotation
        // æŒ‡é‡åŸå§‹ä½ç½® = 1.5 * PI (270åº¦)
        let relativePointerAngle = (1.5 * Math.PI - actualRotation);
        
        // è™•ç†è² æ•¸èˆ‡è¶…éä¸€åœˆçš„æƒ…æ³ï¼Œç¢ºä¿åœ¨ 0 ~ 2PI ä¹‹é–“
        while (relativePointerAngle < 0) relativePointerAngle += Math.PI * 2;
        while (relativePointerAngle >= Math.PI * 2) relativePointerAngle -= Math.PI * 2;

        // æ¯”å°å€é–“
        let winner = null;
        for (let p of participants) {
            if (relativePointerAngle >= p.startAngle && relativePointerAngle < p.endAngle) {
                winner = p;
                break;
            }
        }
        
        // é›™é‡ä¿éšªï¼šè¬ä¸€æµ®é»æ•¸èª¤å·®æ²’æŠ“åˆ°ï¼ŒæŠ“æœ€å¾Œä¸€å€‹
        if (!winner && participants.length > 0) winner = participants[participants.length-1];

        if(winner) {
            let prizeName = prizes[currentPrizeIndex];
            document.getElementById('currentStatusText').innerHTML = `ğŸ‰ æ­å–œ <span style="color:#FF6B6B;">${winner.name}</span> ç²å¾— [ ${prizeName} ]ï¼`;
            
            addResultToList(prizeName, winner);
            participants = participants.filter(p => p !== winner); // ç§»é™¤ä¸­çè€…
            currentPrizeIndex++;

            setTimeout(() => {
                if (currentPrizeIndex < prizes.length && participants.length > 0) {
                    calculateWeights();
                    drawWheel(); // çé …è®Šäº†ï¼Œè½‰ç›¤é‡ç¹ª
                    setTimeout(drawNextPrize, 1000);
                } else {
                    finishDraw();
                }
            }, 3000);
        }
    }

    function finishDraw() {
        isDrawing = false;
        document.getElementById('currentStatusText').innerText = "ğŸŠ æŠ½ççµæŸï¼";
        document.getElementById('spinBtn').style.display = 'none';
        document.getElementById('resetBtn').disabled = false;
        clearInterval(timeInterval);
    }

    function addResultToList(prize, winner) {
        const resultDiv = document.getElementById('resultItems');
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
            <div><span class="prize-name">${prize}</span></div>
            <div style="text-align:right;">
                <span class="winner-name">${winner.name}</span><br>
                <span style="font-size:0.8em; color:#999;">$${winner.amount}</span>
            </div>
        `;
        resultDiv.prepend(item);
    }

    function updateTimestamp() {
        const now = new Date();
        document.getElementById('timestamp').innerText = now.toLocaleString('zh-TW', { hour12: false });
    }

    function reset() {
        if (isDrawing) return;
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('lotterySection').style.display = 'none';
        document.getElementById('spinBtn').disabled = false;
        currentRotation = 0;
    }
</script>
</body>
</html>
